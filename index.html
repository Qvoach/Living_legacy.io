<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–æ–º–æ–π</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js?57"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <input type="file" accept="image/*" id="photo-input" style="display: none;">
  <div class="container">
    <header class="header">
        <div class="user-info">
          <img id="user-photo" src="img/istockphoto-1495088043-612x612.jpg" alt="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width: 100px; height: 100px; border-radius: 50%;margin-left: 8%;">
          <span id="user-name" style="font-size: 40px;"></span>
        </div>
    </header>

    <div class="tasks">
      <div class="task">–ó–∞–¥–∞—á–∏</div>
      <div class="buttons">
        <div class="button">–ü–æ–ª–∏–≤</div>
        <div class="button" >–û—Å–º–æ—Ç—Ä</div>
        <div class="button">–ú—É–ª—å—á–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
      </div>
    </div>

    <div class="info">
      <div class="cedar-section">
        –ö–µ–¥—Ä: 
        <span class="size-container">
          <span id="cedar-size">0</span>
          <input type="number" id="size-input" style="display: none;"step="0.01" min="0" lang="ru">
        </span>&nbsp;—Å–º
      </div>
      <div class="photo-date">
        <span id="photo-date"></span>
      </div>
      <img id="current-photo" src="" alt="–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ" style="max-width: 140px; height: 140px; margin-left: 10px;position: absolute;right: 5%;top: 3%; border-radius: 10px;">
      <div class="button-change" id="change-size-btn">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</div>
      <div class="button-history">–ò—Å—Ç–æ—Ä–∏—è</div>
      <div class="button-photo">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</div>
    </div>



    <div class="bottom-menu">
      <a href="tournament.html" class="menu-item" data-page="tournament">
        <div class="icon-container">
          <img src="img/tournament-gray.svg" alt="–¢—É—Ä–Ω–∏—Ä (—Å–µ—Ä—ã–π)" class="gray">
          <img src="img/tournament-green.svg" alt="–¢—É—Ä–Ω–∏—Ä (–∑–µ–ª–µ–Ω—ã–π)" class="green">
        </div>
        <span>–¢—É—Ä–Ω–∏—Ä</span>
      </a>
      <a href="index.html" class="menu-item active" data-page="home">
        <div class="icon-container">
          <img src="img/home-gray.svg" alt="–î–æ–º–æ–π (—Å–µ—Ä—ã–π)" class="gray">
          <img src="img/home-green.svg" alt="–î–æ–º–æ–π (–∑–µ–ª–µ–Ω—ã–π)" class="green">
        </div>
        <span>–î–æ–º–æ–π</span>
      </a>
      <a href="settings.html" class="menu-item" data-page="settings">
        <div class="icon-container">
          <img src="img/settings-gray.svg" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–µ—Ä—ã–π)" class="gray">
          <img src="img/settings-green.svg" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∑–µ–ª–µ–Ω—ã–π)" class="green">
        </div>
        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </a>
    </div>
  </div>



  <script>
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ–Ω—é (–¢—É—Ä–Ω–∏—Ä, –î–æ–º–æ–π, –ù–∞—Å—Ç—Ä–æ–π–∫–∏)
    const menuItems = document.querySelectorAll('.menu-item');

    function handleMenuClick(event) {
      event.preventDefault();
      menuItems.forEach(item => item.classList.remove('active'));
      event.currentTarget.classList.add('active');
      localStorage.setItem('activePage', event.currentTarget.dataset.page);
      window.location.href = event.currentTarget.href;
    }

    menuItems.forEach(item => item.addEventListener('click', handleMenuClick));

    window.addEventListener('load', () => {
      const path = window.location.pathname;

      let currentPage = 'home'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî index.html
      if (path.includes('tournament')) currentPage = 'tournament';
      else if (path.includes('settings')) currentPage = 'settings';

      localStorage.setItem('activePage', currentPage);

      menuItems.forEach(item => {
        item.classList.toggle('active', item.dataset.page === currentPage);
      });
    });
    //–ü–æ–ª–∏–≤ –û—Å–º–æ—Ç—Ä –ú—É–ª—å—á–∏—Ä–æ–≤–∞–Ω–∏–µ
    document.addEventListener('DOMContentLoaded', function () {
      const buttons = document.querySelectorAll('.button');

      buttons.forEach(button => {
        const buttonKey = button.innerText;
        if (localStorage.getItem(buttonKey) === 'clicked') {
          button.classList.add('clicked');
        }

        button.addEventListener('click', function () {
          const isClicked = button.classList.toggle('clicked');
          if (isClicked) {
            localStorage.setItem(buttonKey, 'clicked');
          } else {
            localStorage.removeItem(buttonKey);
          }
        });
      });
    });
    //–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
    document.addEventListener('DOMContentLoaded',
    function () {
      if (window.Telegram && window.Telegram.WebApp) {
        const user = Telegram.WebApp.initDataUnsafe.user;
        if (user) {
          const userName = `${user.first_name} ${user.last_name || ''}`.trim();
          const photoUrl = user.photo_url || 'default_photo.jpg';
          
          const nameElement = document.getElementById('user-name');
          const photoElement = document.getElementById('user-photo');
          
          if (nameElement) {
            nameElement.textContent = userName;
          }
          if (photoElement) {
            photoElement.src = photoUrl;
            photoElement.alt = userName;
          }
        }
      }
    });
 
    //–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä

  document.addEventListener('DOMContentLoaded', function () {
  const cedarSizeElement = document.getElementById('cedar-size');
  const changeSizeButton = document.getElementById('change-size-btn');
  const sizeInput = document.getElementById('size-input');

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
  const savedSize = localStorage.getItem('cedarSize');
  if (savedSize) {
    cedarSizeElement.textContent = savedSize.replace('.', ','); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å –∑–∞–ø—è—Ç–æ–π
  } else {
    cedarSizeElement.textContent = '0';
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
  changeSizeButton.addEventListener('click', function () {
    const currentText = cedarSizeElement.textContent.replace(',', '.'); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ
    cedarSizeElement.style.display = 'none';
    sizeInput.style.display = 'inline-block';
    sizeInput.value = parseFloat(currentText) || 0;
    sizeInput.focus();
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Supabase
  const saveAndSendToSupabase = async () => {
    if (sizeInput.style.display !== 'inline-block') return;

    let newValue = sizeInput.value.replace(',', '.'); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–∞–ø—è—Ç—É—é –≤ —Ç–æ—á–∫—É –¥–ª—è Supabase
    let numericValue = parseFloat(newValue) || 0;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å –∑–∞–ø—è—Ç–æ–π
    cedarSizeElement.textContent = numericValue.toFixed(2).replace('.', ','); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å –∑–∞–ø—è—Ç–æ–π
    cedarSizeElement.style.display = 'inline-block';
    sizeInput.style.display = 'none';
    localStorage.setItem('cedarSize', numericValue.toFixed(2)); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å —Ç–æ—á–∫–æ–π

    // Supabase –∏ Telegram
    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://gewontcvsqhogoqjeavi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdld29udGN2c3Fob2dvcWplYXZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMDI3MzIsImV4cCI6MjA2NTY3ODczMn0.K5lUX-rHdIC3MCdRgCk4giDjPGjiHTg7SBHgJmcT4VA'
    );

    let telegramUser = { id: 0, username: 'TestUser' };
    if (window.Telegram && Telegram.WebApp) {
      const user = Telegram.WebApp.initDataUnsafe.user;
      if (user && user.id) {
        telegramUser = {
          id: user.id,
          username: user.username || `${user.first_name || ''} ${user.last_name || ''}`.trim()
        };
      }
    }

    try {
      const score = parseFloat(newValue) || 0;

      const { error } = await supabaseClient
        .from('tournament_scores')
        .upsert({
          telegram_id: telegramUser.id,
          username: telegramUser.username || '–ê–Ω–æ–Ω–∏–º',
          score: score
        }, { onConflict: ['telegram_id'] });

      console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Supabase:', {
        telegram_id: telegramUser.id,
        username: telegramUser.username,
        score
      });

      if (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ Supabase:', error.message);
      } else {
        console.log('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ.');
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', e.message);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞ (blur)
  sizeInput.addEventListener('blur', async () => {
  await saveAndSendToSupabase();

  // üëá –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä–æ–ª–ª–∏–º –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞—Ç—å—Å—è –≤–Ω–∏–∑—É
  window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
  sizeInput.addEventListener('keypress', function (event) {
    if (event.key === 'Enter') {
      sizeInput.blur();
    }
  });

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (touchstart) –∏ –ü–ö (click)
  const handleOutsideInteraction = (event) => {
    if (
      sizeInput.style.display === 'inline-block' &&
      event.target !== sizeInput &&
      event.target !== changeSizeButton
    ) {
      saveAndSendToSupabase();
    }
  };

  document.addEventListener('touchstart', handleOutsideInteraction);
  document.addEventListener('click', handleOutsideInteraction);
});

    //–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
    document.addEventListener('DOMContentLoaded', function () {

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ –∏ –¥–∞—Ç—ã
      const savedPhoto = localStorage.getItem('currentPhoto');
      const savedDate = localStorage.getItem('photoDate');
      if (savedPhoto) {
        document.getElementById('current-photo').src = savedPhoto;
      }
      if (savedDate) {
        document.getElementById('photo-date').textContent = `–§–æ—Ç–æ:${savedDate}`;
      }

      // –ó–∞–ø—É—Å–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
      document.querySelector('.button-photo').addEventListener('click', function() {
        document.getElementById('photo-input').click();
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
      document.getElementById('photo-input').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
  const dataURL = e.target.result;
  const currentPhoto = document.getElementById('current-photo').src;

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ –≤ –∏—Å—Ç–æ—Ä–∏—é
    let history = JSON.parse(localStorage.getItem('photoHistory') || '[]');
    if (currentPhoto && currentPhoto.startsWith('data:image')) {
      history.push({
        src: currentPhoto,
        date: localStorage.getItem('photoDate')
      });
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ –∏ –¥–∞—Ç—É
    const now = new Date();
    const dateString = now.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
    document.getElementById('current-photo').src = dataURL;
    document.getElementById('photo-date').textContent = `–§–æ—Ç–æ:${dateString}`;

    // –§—É–Ω–∫—Ü–∏—è —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    function trySavePhoto() {
      try {
        localStorage.setItem('photoHistory', JSON.stringify(history));
        localStorage.setItem('currentPhoto', dataURL);
        localStorage.setItem('photoDate', dateString);
      } catch (err) {
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî —É–¥–∞–ª—è–µ–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
        if (history.length > 0) {
          history.shift(); // –£–¥–∞–ª—è–µ–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ
          trySavePhoto(); // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
        } else {
          Telegram.WebApp?.showAlert?.('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ.');
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', err.message);
        }
      }
    }

    trySavePhoto();
  };
          reader.readAsDataURL(file);
        }
      });

      // –ö–Ω–æ–ø–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
      document.querySelector('.button-history').addEventListener('click', function() {
        window.location.href = 'history.html';
      });
    });



  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ –º–µ–Ω—é –≤–Ω–∏–∑—É
    setInterval(() => {
    const bottomMenu = document.querySelector('.bottom-menu');
    if (bottomMenu && bottomMenu.style.bottom !== '0px') {
      bottomMenu.style.bottom = '0px';
      console.log('Forced bottom: 0px');
    }
  }, 100);

  // –ù–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è Telegram
  if (window.Telegram && Telegram.WebApp) {
    Telegram.WebApp.expand();
    Telegram.WebApp.disableVerticalSwipes();
    Telegram.WebApp.onEvent('viewportChanged', () => {
      const bottomMenu = document.querySelector('.bottom-menu');
      bottomMenu.style.bottom = '0px';
      console.log('Viewport changed, bottom forced to 0px');
    });
  }
  </script>

</body>
</html>
